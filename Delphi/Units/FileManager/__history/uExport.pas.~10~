unit uExport;

interface
uses
  uBlockManager, Vcl.Graphics, Vcl.ExtCtrls, uAdditionalTypes, uConstants;

procedure SaveBMPFile(const ABlockManager: TBlockManager; const AFileName: string);
implementation

  procedure SaveBMPFile(const ABlockManager: TBlockManager; const AFileName: string);
  var
    VisibleImageRect: TVisibleImageRect;
    Bitmap: TBitmap;
    PrevCanvas: TCanvas;
  begin
    PrevCanvas:= ABlockManager.MainBlock.Canvas;
    Bitmap := TBitmap.Create;
    try
      Bitmap.Width := ABlockManager.MainBlock.XLast + SchemeIndent;
      Bitmap.Height := ABlockManager.MainBlock.Statements[ABlockManager.MainBlock.
                       Statements.Count - 1].GetYBottom + SchemeIndent;
      Bitmap.Canvas.Font := ABlockManager.Font;
      Bitmap.Canvas.Pen := ABlockManager.Pen;

      VisibleImageRect.FTopLeft.X := 0;
      VisibleImageRect.FTopLeft.Y := 0;
      VisibleImageRect.FBottomRight.X := Bitmap.Width;
      VisibleImageRect.FBottomRight.Y := Bitmap.Height;

      ABlockManager.MainBlock.InstallCanvas(Bitmap.Canvas);
      ABlockManager.MainBlock.DrawBlock(VisibleImageRect);

      Bitmap.SaveToFile(AFileName);
    finally
      Bitmap.Destroy;
    end;
    ABlockManager.MainBlock.InstallCanvas(PrevCanvas);
  end;

end.
