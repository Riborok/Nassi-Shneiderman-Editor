unit LastLoop;

interface
uses FirstLoop, Base, vcl.graphics, Vcl.ExtCtrls, DrawShapes;
type

  TLastLoop = class(TFirstLoop)
  protected
    procedure CreateBlock(const ABaseBlock: TBlock); override;
    procedure InitializeBlock; override;
    function GetOptimalHeight: Integer; override;
    function GetInitialY: Integer; override;
  public
    procedure Draw; override;
  end;

implementation

  procedure TLastLoop.CreateBlock(const ABaseBlock: TBlock);
  begin
    SetLength(FBlock, FBlockCount);
    FBlock[0] := TBlock.Create(GetXLastStrip, ABaseBlock.XLast, Self);
  end;

  procedure TLastLoop.InitializeBlock;
  var
    NewStatement: TStatement;
  begin
    NewStatement:= DefaultBlock.CreateUncertainty(FYStart, FBlock[0], FImage);
    FBlock[0].Statements.Add(NewStatement);
    NewStatement.SetOptimalHeight;
  end;

  procedure TLastLoop.Draw;
  begin
    DrawRectangle(BaseBlock.XStart, BaseBlock.XLast, GetYBottom, FYLast, FImage);

    DrawRectangle(BaseBlock.XStart, GetXLastStrip, FBlock[0].Statements[0].YStart,
                                                              GetYBottom, FImage);

    Erase(BaseBlock.XStart +  1, GetXLastStrip, FYLast, FYLast, FImage.Canvas);

    DrawText(FImage.Canvas, BaseBlock.XStart + ((BaseBlock.XLast - BaseBlock.XStart) div 2)
      - (GetTextWidth(FImage.Canvas, Action) div 2), GetYBottom + YIndentText, Action);

    FBlock[0].DrawBlock;
  end;

  function GetInitialY: Integer; override;

  function TLastLoop.GetOptimalHeight: Integer;
  begin
    Result := GetYBottom + GetTextWidth(FImage.Canvas, FAction) + 2 * XMinIndentText;
  end;

end.
